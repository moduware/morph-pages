<link rel="import" href="../morph-element/morph-element.html">
<link rel="import" href="../iron-location/iron-location.html">

<dom-module id="morph-location">
  <script>

    var detectBackOrForward = function(onBack, onForward) {
      locationHistory = [window.location.href];
      historyLength = window.history.length;
      historyPosition = 0;

      return function(replace) {
        replace = replace || false;
        var newLocation = window.location.href, newHistoryLength = window.history.length;

        if(replace) {
          locationHistory[historyPosition] = newLocation;
        } else if (locationHistory.length && historyLength == newHistoryLength) {
          var previousLocation = locationHistory[historyPosition - 1];
          if (previousLocation == newLocation) {
            //locationHistory = locationHistory.slice(0, -1);
            historyPosition--;
            onBack();
          } else {
            historyPosition++;
            //locationHistory.push(newLocation);
            onForward();
          }
        } else {
          historyPosition++;
          locationHistory = locationHistory.slice(0, historyPosition);
          locationHistory.push(newLocation);
          historyLength = newHistoryLength;
        }
        console.log('historyLength', historyLength);
        console.log('historyPosition', historyPosition);
      }
    };

    // window.addEventListener('hashchange', detectBackOrForward(
    //   function() { console.log('back') },
    //   function() { console.log('forward') }
    // ));

    var historyHandler = detectBackOrForward(
      () => console.log('backward'),
      () => console.log('forward')
    );

    window.addEventListener('popstate', (event) => {
      historyHandler();
      console.log('popState', window.location.href);
    });

    const _historyReplaceState = history.replaceState;
    history.replaceState = function(state) {
      //console.log(state);
      _historyReplaceState.call(this, ...arguments);
      historyHandler(true);
      console.log('replaceState', window.location.href);
    };

    const _historyPushState = history.pushState;
    history.pushState = function(state) {
      //console.log(state);
      _historyPushState.call(this, ...arguments);
      historyHandler();
      console.log('pushState', window.location.href);
    };

    const IronLocationSuperClass = customElements.get('iron-location');

    class MorphLocation extends MorphElement(IronLocationSuperClass) {
      static get is() { return 'morph-location'; }

      static get properties() { 
        return {
          lastNavigationDirection: {
            type: String,
            //value: null, // no default value, possible values: 'forward', 'backward'
            notify: true,
            reflectToAttribute: true
          }
        }; 
      }

      constructor() {
        let _locationChangeHandler = () => {
          this.set('lastNavigationDirection', 'forward');
        };

        let _statePopHandler = () => {
          this.set('lastNavigationDirection', 'backward');
        };

        window.addEventListener('hashchange', _locationChangeHandler);
        window.addEventListener('popstate', _statePopHandler);

        super();

        this._locationChangeHandler = _locationChangeHandler;
        this._statePopHandler = _statePopHandler;
      }

      ready() {
        super.ready();
      }

      connectedCallback() {
        super.connectedCallback();
      }

      disconnectedCallback() {
        super.disconnectedCallback();

        window.removeEventListener('location-changed', this._locationChangeHandler);
        window.removeEventListener('popstate', this._statePopHandler);
      }
    }

    window.customElements.define(MorphLocation.is, MorphLocation);
  </script>
</dom-module>